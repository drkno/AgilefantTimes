<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8"/>
    <title>Agilefant Times</title>
    <style>
        body {
            text-align: center;
        }
        
	    #title {
		    font-family: Arial, Helvetica;
		    margin-top: 0;
		    margin-bottom: 2px;
	    }

        #times {
            display: inline-block;
        }

        #statsTable {
            display: none;
        }

        #sprintPicker {
            display: none;
            margin-top: 1px;
            margin-bottom: 1px;
        }

        table {
            border: none;
            outline: none;
            text-align: center;
            display: inline-block;
            border-collapse: collapse;
        }

        thead {
            margin: 0;
            font-weight: light;
            background-color: #E9E9E9;
        }

        th {
            padding: 5px 10px 5px 10px;
        }

        td {
            padding: 5px;
            width: 200px;
            border-left: 1px solid #E9E9E9;
        }

        td:first-child {
            border-left: none;
        }
    </style>
</head>
<body>
<h2 id="title"></h2>
    <p id="sprintPicker">
        Sprint:
        <select onchange="loadTimes(this.value)">
            <option value="">Auto Detect</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
        </select>
    </p>
    <div id="times">Please Wait, loading times...</div>
    <br>
    <canvas id="canvas" height="250" width="600"></canvas>
    <br>
<table id="statsTable">
    <thead>
    <tr>
        <th>Average</th>
        <th>Minimum</th>
        <th>Median</th>
        <th>Maximum</th>
        <th>Total</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td id="average"></td>
        <td id="min"></td>
        <td id="median"></td>
        <td id="max"></td>
        <td id="total"></td>
    </tr>
    </tbody>
</table>
<script src="Chart.min.js"></script>
<script>
    /**
     * Loads times from the API.
     * @param sprint the sprint number to load
     */
    function loadTimes(sprint) {
        displayLoading(true);

        var sprintArgs = "";
        if (sprint && !isNaN(sprint)) {
            sprintArgs = "/sprint/" + sprint;
        }

        var webRequest = (window.XMLHttpRequest) ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
        webRequest.onreadystatechange = function() {
            if (webRequest.readyState === 4 && webRequest.status === 200) {
                var response = JSON.parse(webRequest.responseText);
                displayTimes(response.Hours, response.SprintName, response.TeamName);
                displayLoading(false);
            } else if (webRequest.readyState === 4 && webRequest.status >= 400) {
                document.getElementById("times").innerHTML = "An error with code " + webRequest.status + " occured while retreiving times.";
            }
        }
        webRequest.open("GET", "GetJson.php" + sprintArgs, true);
        webRequest.send();
    }

    /**
     * Displays or removes the loading UI from the page.
     * @param currentlyLoading wheather the page is currently loading or not.
     */
    function displayLoading(currentlyLoading) {
        if (currentlyLoading) {
            document.getElementById("times").innerHTML = "Please Wait, loading times...";
            document.getElementById("title").style.display = "none";
            document.getElementById("statsTable").style.display = "none";
            document.getElementById("sprintPicker").style.display = "none";
            if (window.myBar) {
                window.myBar.destroy();
            }
        } else {
            document.getElementById("title").style.display = "block";
            document.getElementById("statsTable").style.display = "inline-block";
            document.getElementById("sprintPicker").style.display = "block";
        }
    }

    /**
     * Displays a bar graph of values.
     * @param columns column names to display.
     * @param data data to display.
     */
    function displayGraph(columns, data) {
        var barChartData = {
            labels: columns,
            datasets: [
                {
                    fillColor: "rgba(220,220,220,0.5)",
                    strokeColor: "rgba(220,220,220,0.8)",
                    highlightFill: "#FF5A5E",
                    highlightStroke: "rgba(220,220,220,1)",
                    data: data
                }
            ]
        };

        var canvas = document.getElementById("canvas");
        canvas.height = 250;
        canvas.width = 900;
        var ctx = canvas.getContext("2d");
        window.myBar = new Chart(ctx).Bar(barChartData, {
            responsive: true
        });
    }

    /**
     * Updates the UI to show the specified times.
     * @param times times to display.
     * @param sprint sprint that these times represent.
     * @param teamName Agilefant team name that these values represent.
     */
    function displayTimes(times, sprint, teamName) {
        document.getElementById("title").innerHTML = sprint + " (" + teamName + ")";

        var columns = [];
        var data = [];
        var average = 0.0;
        var table = "<table><thead><tr><th>Person</th><th>Task Hours</th><th>Story Hours</th><th>Total Hours</th></tr></thead><tbody>";
        for (var i = 0; i < times.length; i++) {
            table += "<tr><td>"
                + times[i].Name + "</td><td>"
                + roundToOneDp(times[i].TaskHours) + "</td><td>"
                + roundToOneDp(times[i].StoryHours) + "</td><td>"
                + roundToOneDp(times[i].TotalHours) + "</td></tr>";

            columns[columns.length] = times[i].Name;
            data[data.length] = roundToOneDp(times[i].TotalHours);
            average += times[i].TotalHours;
        }
        table += "</tbody></table>";
        var element = document.getElementById("times");
        element.innerHTML = table;

        displayGraph(columns, data);

        document.getElementById("total").innerHTML = roundToOneDp(average);
        average /= data.length;
        document.getElementById("average").innerHTML = roundToOneDp(average);
        var maxIndex = data.indexOf(Math.max.apply(Math, data));
        document.getElementById("max").innerHTML = roundToOneDp(data[maxIndex]) + " (" + columns[maxIndex] + ")";
        var minIndex = data.indexOf(Math.min.apply(Math, data));
        document.getElementById("min").innerHTML = roundToOneDp(data[minIndex]) + " (" + columns[minIndex] + ")";
        var median = getMedian(data);
        document.getElementById("median").innerHTML = roundToOneDp(data[median]) + " (" + columns[median] + ")";
        
    }

    /**
     * Rounds a number to 1dp or less.
     * @param number number to round.
     * @returns number rounded to 1dp or less.
     */
    function roundToOneDp(number) {
        return +(Math.round(number + "e+1") + "e-1");
    }

    /**
     * Gets the median index of an array of values.
     * @param values array to get median of.
     * @returns index of median.
     */
    function getMedian(values) {
        var vals = values.slice();
        vals.sort(function (a, b) { return a - b });
        var half = Math.floor(values.length / 2);
        return values.indexOf(vals[half]);
    }

    loadTimes();
</script>
</body>
</html>